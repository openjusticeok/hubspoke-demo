# CI/CD: Dev - Application Build and Deploy Pipeline
#
# IMPORTANT PREREQUISITE:
# Base infrastructure must be provisioned manually first via tofu apply.
# This includes: Artifact Registry, GCS buckets, IAM permissions, and GCP APIs.
# Run: cd infra && tofu apply -var-file="dev.tfvars" -var="image_version=initial"
#
# This workflow assumes the "Landing Zone" (base infrastructure) already exists
# and focuses on the "Application Zone" (build, push, deploy).
# See README.md for initial setup instructions.

name: "CI/CD: Dev"

on:
  push:
    branches: [main]
    paths-ignore:
      - 'infra/prod.tfvars'
      - 'README.md'
      - '.gitignore'
      - 'CODEOWNERS'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if artifacts exist'
        required: false
        default: false
        type: boolean

# CRITICAL: Concurrency Control - Cancel running dev deploy on new commit
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.check.outputs.sha }}
      repo_url: ${{ steps.check.outputs.repo_url }}
      bucket: ${{ steps.check.outputs.bucket }}
      build_skipped: ${{ steps.check.outputs.exists }}
    steps:
      # FREE DISK SPACE: Required for GCE image builds (VM images are large)
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # OPTIMIZATION: Magic Nix Cache - Binary caching for Nix store
      - uses: DeterminateSystems/magic-nix-cache-action@v2

      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - uses: 'google-github-actions/auth@v2'
        with:
          project_id: 'hubspoke-demo-dev-b87d'
          workload_identity_provider: '${{ secrets.GCP_WIF_PROVIDER }}'
          service_account: 'tofu-provisioner@hubspoke-demo-dev-b87d.iam.gserviceaccount.com'

      - uses: 'google-github-actions/setup-gcloud@v2'

      # OPTIMIZATION: Check for existing artifacts to skip unnecessary builds
      - name: Check for Existing Artifacts
        id: check
        run: |
          SHA=$(git rev-parse --short HEAD)
          PROJECT="hubspoke-demo-dev-b87d"
          REPO_URL="us-central1-docker.pkg.dev/$PROJECT/repo/hubspoke-demo"
          BUCKET="hubspoke-demo-dev-nixos-images"
          
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "bucket=$BUCKET" >> $GITHUB_OUTPUT
          
          # Check if force rebuild requested
          if [[ "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
            echo "::notice title=Force Rebuild::Force rebuild requested. Building regardless of existing artifacts."
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check Container
          echo "ðŸ” Checking Artifact Registry for container..."
          if gcloud artifacts docker images describe "$REPO_URL:$SHA" > /dev/null 2>&1; then
            CONTAINER_EXISTS=true
            echo "âœ… Container image exists"
          else
            CONTAINER_EXISTS=false
            echo "âŒ Container image not found"
          fi
          
          # Check GCE Image
          echo "ðŸ” Checking GCS for GCE image..."
          if gsutil ls "gs://$BUCKET/nixos-image-$SHA.tar.gz" > /dev/null 2>&1; then
            GCE_EXISTS=true
            echo "âœ… GCE image exists"
          else
            GCE_EXISTS=false
            echo "âŒ GCE image not found"
          fi
          
          # Decision: Skip only if BOTH exist
          if [[ "$CONTAINER_EXISTS" == "true" && "$GCE_EXISTS" == "true" ]]; then
            echo "::notice title=Build Skipped::Artifacts for $SHA already exist. Skipping Nix builds."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "::notice title=Build Required::Missing artifacts for $SHA. Running Nix builds."
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure Docker Auth
        if: steps.check.outputs.exists != 'true'
        run: |
          # Configure docker to use gcloud credentials for Artifact Registry
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build & Push Container
        if: steps.check.outputs.exists != 'true'
        run: |
          echo "â„ï¸ Building Container..."
          nix run .#container.copyToDockerDaemon
          
          SHA=${{ steps.check.outputs.sha }}
          REPO_URL="${{ steps.check.outputs.repo_url }}"
          
          echo "Available images:"
          docker images | grep hubspoke-demo
          
          # Find and tag the built image
          IMAGE_NAME=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "hubspoke-demo" | head -1)
          echo "Found image: $IMAGE_NAME"
          
          docker tag $IMAGE_NAME $REPO_URL:$SHA
          skopeo copy docker-daemon:$REPO_URL:$SHA docker://$REPO_URL:$SHA
          echo "âœ… Container pushed to $REPO_URL:$SHA"

      - name: Build GCE Image
        if: steps.check.outputs.exists != 'true'
        run: |
          echo "â„ï¸ Building GCE Image..."
          nix build .#gce-image --out-link gce-result
          echo "GCE image build complete. Contents:"
          ls -la gce-result/
          find gce-result/ -type f \( -name "*.tar.gz" -o -name "*.raw*" \)

      - name: Push GCE Image
        if: steps.check.outputs.exists != 'true'
        run: |
          SHA=${{ steps.check.outputs.sha }}
          BUCKET="${{ steps.check.outputs.bucket }}"
          
          # Find the actual image file (NixOS GCE image naming varies)
          IMAGE_FILE=$(find gce-result/ -type f \( -name "*.tar.gz" -o -name "*.raw*" \) | head -1)
          echo "Found image file: $IMAGE_FILE"
          
          gsutil cp "$IMAGE_FILE" "gs://$BUCKET/nixos-image-$SHA.tar.gz"
          echo "âœ… GCE image pushed to gs://$BUCKET/nixos-image-$SHA.tar.gz"

  deploy-dev:
    needs: build
    # Run even if build was skipped (for tofu-only changes)
    if: always() && needs.build.result != 'failure'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Parse Environment Config
        id: config
        run: |
          SA=$(grep -E '^\s*service_account\s*=' infra/dev.tfvars | head -1 | sed -E 's/.*=\s*"([^"]+)".*/\1/')
          BUCKET=$(grep -E '^\s*state_bucket\s*=' infra/dev.tfvars | head -1 | sed -E 's/.*=\s*"([^"]+)".*/\1/')
          echo "service_account=$SA" >> $GITHUB_OUTPUT
          echo "state_bucket=$BUCKET" >> $GITHUB_OUTPUT

      - uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.GCP_WIF_PROVIDER }}'
          service_account: ${{ steps.config.outputs.service_account }}

      - uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.8.1'

      # OPTIMIZATION: Cache provider plugins
      - uses: actions/cache@v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: tofu-plugins-${{ runner.os }}-${{ hashFiles('infra/.terraform.lock.hcl') }}
          restore-keys: |
            tofu-plugins-${{ runner.os }}-

      - name: Configure Tofu Plugin Cache
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo "plugin_cache_dir = \"$HOME/.terraform.d/plugin-cache\"" > ~/.terraformrc

      - name: Tofu Init
        working-directory: ./infra
        run: tofu init -backend-config="bucket=${{ steps.config.outputs.state_bucket }}"

      - name: Tofu Plan
        working-directory: ./infra
        run: |
          tofu plan \
            -var-file="dev.tfvars" \
            -var="image_version=${{ needs.build.outputs.sha }}" \
            -no-color

      - name: Tofu Apply
        if: github.ref == 'refs/heads/main'
        working-directory: ./infra
        run: |
          tofu apply \
            -var-file="dev.tfvars" \
            -var="image_version=${{ needs.build.outputs.sha }}" \
            -auto-approve \
            -no-color
