# CI/CD: Dev - Application Build and Deploy Pipeline (Fan-Out/Fan-In)
#
# IMPORTANT PREREQUISITE:
# Base infrastructure must be provisioned manually first via tofu apply.
# This includes: Artifact Registry, GCS buckets, IAM permissions, and GCP APIs.
# Run: cd infra && tofu apply -var-file="dev.tfvars" -var="image_version=initial"
#
# This workflow assumes the "Landing Zone" (base infrastructure) already exists
# and focuses on the "Application Zone" (build, push, deploy).
# See README.md for initial setup instructions.
#
# ARCHITECTURE: Fan-Out / Fan-In
# - Fan-Out: build-container and build-gce run in parallel (each with full 14GB disk)
# - Fan-In: deploy-dev waits for both, then deploys infrastructure

name: "CI/CD: Dev"

on:
  push:
    branches: [main]
    paths-ignore:
      - 'infra/prod.tfvars'
      - 'README.md'
      - '.gitignore'
      - 'CODEOWNERS'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if artifacts exist'
        required: false
        default: false
        type: boolean

# CRITICAL: Concurrency Control - Cancel running dev deploy on new commit
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  # --- FAN-OUT: Build Container (14GB dedicated disk space) ---
  build-container:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.version.outputs.sha }}
      repo_url: ${{ steps.version.outputs.repo_url }}
      container_exists: ${{ steps.check.outputs.container_exists }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Version
        id: version
        run: |
          SHA=$(git rev-parse HEAD)
          PROJECT="hubspoke-demo-dev-b87d"
          REPO_URL="us-central1-docker.pkg.dev/$PROJECT/repo/hubspoke-demo"
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "Building version: $SHA"

      # OPTIMIZATION: Magic Nix Cache - Binary caching for Nix store
      - uses: DeterminateSystems/magic-nix-cache-action@v2

      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - uses: 'google-github-actions/auth@v2'
        with:
          project_id: 'hubspoke-demo-dev-b87d'
          workload_identity_provider: '${{ secrets.GCP_WIF_PROVIDER }}'
          service_account: 'tofu-provisioner@hubspoke-demo-dev-b87d.iam.gserviceaccount.com'

      - uses: 'google-github-actions/setup-gcloud@v2'

      # Check for existing container
      - name: Check for Existing Container
        id: check
        run: |
          SHA=${{ steps.version.outputs.sha }}
          REPO_URL="${{ steps.version.outputs.repo_url }}"
          
          # Check if force rebuild requested
          if [[ "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
            echo "::notice title=Force Rebuild::Force rebuild requested. Building container."
            echo "container_exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸ” Checking Artifact Registry for container..."
          if gcloud artifacts docker images describe "$REPO_URL:$SHA" > /dev/null 2>&1; then
            echo "::notice title=Container Exists::Image $SHA already exists. Skipping build."
            echo "container_exists=true" >> $GITHUB_OUTPUT
          else
            echo "::notice title=Build Required::Container image not found. Building."
            echo "container_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure Docker Auth
        if: steps.check.outputs.container_exists != 'true'
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build & Push Container
        if: steps.check.outputs.container_exists != 'true'
        run: |
          echo "â„ï¸ Building Container..."
          nix run .#container.copyToDockerDaemon
          
          SHA=${{ steps.version.outputs.sha }}
          REPO_URL="${{ steps.version.outputs.repo_url }}"
          
          echo "Available images:"
          docker images | grep hubspoke-demo
          
          IMAGE_NAME=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "hubspoke-demo" | head -1)
          echo "Found image: $IMAGE_NAME"
          
          docker tag $IMAGE_NAME $REPO_URL:$SHA
          skopeo copy docker-daemon:$REPO_URL:$SHA docker://$REPO_URL:$SHA
          echo "âœ… Container pushed to $REPO_URL:$SHA"

  # --- FAN-OUT: Build GCE Image (14GB dedicated disk space, parallel to container) ---
  build-gce:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.version.outputs.sha }}
      bucket: ${{ steps.version.outputs.bucket }}
      gce_exists: ${{ steps.check.outputs.gce_exists }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Version
        id: version
        run: |
          SHA=$(git rev-parse HEAD)
          BUCKET="hubspoke-demo-dev-nixos-images"
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "bucket=$BUCKET" >> $GITHUB_OUTPUT
          echo "Building GCE image version: $SHA"

      # OPTIMIZATION: Magic Nix Cache - Binary caching for Nix store
      - uses: DeterminateSystems/magic-nix-cache-action@v2

      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - uses: 'google-github-actions/auth@v2'
        with:
          project_id: 'hubspoke-demo-dev-b87d'
          workload_identity_provider: '${{ secrets.GCP_WIF_PROVIDER }}'
          service_account: 'tofu-provisioner@hubspoke-demo-dev-b87d.iam.gserviceaccount.com'

      - uses: 'google-github-actions/setup-gcloud@v2'

      # Check for existing GCE image
      - name: Check for Existing GCE Image
        id: check
        run: |
          SHA=${{ steps.version.outputs.sha }}
          BUCKET="${{ steps.version.outputs.bucket }}"
          
          # Check if force rebuild requested
          if [[ "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
            echo "::notice title=Force Rebuild::Force rebuild requested. Building GCE image."
            echo "gce_exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸ” Checking GCS for GCE image..."
          if gsutil ls "gs://$BUCKET/nixos-image-$SHA.tar.gz" > /dev/null 2>&1; then
            echo "::notice title=GCE Image Exists::Image $SHA already exists. Skipping build."
            echo "gce_exists=true" >> $GITHUB_OUTPUT
          else
            echo "::notice title=Build Required::GCE image not found. Building."
            echo "gce_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build GCE Image
        if: steps.check.outputs.gce_exists != 'true'
        run: |
          echo "â„ï¸ Building GCE Image..."
          nix build .#gce-image --out-link gce-result
          echo "GCE image build complete. Contents:"
          ls -la gce-result/
          find gce-result/ -type f \( -name "*.tar.gz" -o -name "*.raw*" \)

      - name: Push GCE Image
        if: steps.check.outputs.gce_exists != 'true'
        run: |
          SHA=${{ steps.version.outputs.sha }}
          BUCKET="${{ steps.version.outputs.bucket }}"
          
          IMAGE_FILE=$(find gce-result/ -type f \( -name "*.tar.gz" -o -name "*.raw*" \) | head -1)
          echo "Found image file: $IMAGE_FILE"
          
          gsutil cp "$IMAGE_FILE" "gs://$BUCKET/nixos-image-$SHA.tar.gz"
          echo "âœ… GCE image pushed to gs://$BUCKET/nixos-image-$SHA.tar.gz"

  # --- FAN-IN: Deploy (waits for both builds, each with full disk space) ---
  deploy-dev:
    needs: [build-container, build-gce]
    # Run even if one build was skipped (as long as neither failed)
    if: always() && needs.build-container.result != 'failure' && needs.build-gce.result != 'failure'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Parse Environment Config
        id: config
        run: |
          SA=$(grep -E '^\s*service_account\s*=' infra/dev.tfvars | head -1 | sed -E 's/.*=\s*"([^"]+)".*/\1/')
          BUCKET=$(grep -E '^\s*state_bucket\s*=' infra/dev.tfvars | head -1 | sed -E 's/.*=\s*"([^"]+)".*/\1/')
          echo "service_account=$SA" >> $GITHUB_OUTPUT
          echo "state_bucket=$BUCKET" >> $GITHUB_OUTPUT

      - uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.GCP_WIF_PROVIDER }}'
          service_account: ${{ steps.config.outputs.service_account }}

      - uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.8.1'

      # OPTIMIZATION: Cache provider plugins
      - uses: actions/cache@v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: tofu-plugins-${{ runner.os }}-${{ hashFiles('infra/.terraform.lock.hcl') }}
          restore-keys: |
            tofu-plugins-${{ runner.os }}-

      - name: Configure Tofu Plugin Cache
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo "plugin_cache_dir = \"$HOME/.terraform.d/plugin-cache\"" > ~/.terraformrc

      - name: Tofu Init
        working-directory: ./infra
        run: tofu init -backend-config="bucket=${{ steps.config.outputs.state_bucket }}"

      - name: Tofu Plan
        working-directory: ./infra
        run: |
          tofu plan \
            -var-file="dev.tfvars" \
            -var="image_version=${{ needs.build-container.outputs.sha }}" \
            -no-color

      - name: Tofu Apply
        if: github.ref == 'refs/heads/main'
        working-directory: ./infra
        run: |
          tofu apply \
            -var-file="dev.tfvars" \
            -var="image_version=${{ needs.build-container.outputs.sha }}" \
            -auto-approve \
            -no-color
