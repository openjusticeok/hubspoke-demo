name: "Release: Production"

on:
  push:
    branches: [main]
    paths:
      - 'infra/prod.tfvars'
  workflow_dispatch:

# CRITICAL: Concurrency Control
concurrency:
  group: production-deployment
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

jobs:
  # Phase 1: Extract and verify configuration
  config:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.parse.outputs.version }}
      service_account: ${{ steps.parse.outputs.service_account }}
      state_bucket: ${{ steps.parse.outputs.state_bucket }}
      project_id: ${{ steps.parse.outputs.project_id }}
      dev_project_id: ${{ steps.parse.outputs.dev_project_id }}
    steps:
      - uses: actions/checkout@v4

      - name: Parse Configuration
        id: parse
        run: |
          # Read all config from prod.tfvars
          PROJECT_ID=$(grep -E '^\s*project_id\s*=' infra/prod.tfvars | head -1 | sed -E 's/.*=\s*"([^"]+)".*/\1/')
          SA=$(grep -E '^\s*service_account\s*=' infra/prod.tfvars | head -1 | sed -E 's/.*=\s*"([^"]+)".*/\1/')
          BUCKET=$(grep -E '^\s*state_bucket\s*=' infra/prod.tfvars | head -1 | sed -E 's/.*=\s*"([^"]+)".*/\1/')
          # Read the version you manually set in prod.tfvars
          VERSION=$(grep -E '^\s*image_version\s*=' infra/prod.tfvars | head -1 | sed -E 's/.*=\s*"([^"]+)".*/\1/')
          
          # Derive dev project ID from prod service account
          # Format: tofu-provisioner@hubspoke-demo-dev-b87d.iam.gserviceaccount.com
          DEV_PROJECT_ID=$(echo "$SA" | sed -E 's/.*@([^\.]+)\.iam\.gserviceaccount\.com/\1/' | sed 's/-prod-[a-f0-9]\{4\}/-dev-b87d/')
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "service_account=$SA" >> $GITHUB_OUTPUT
          echo "state_bucket=$BUCKET" >> $GITHUB_OUTPUT
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "dev_project_id=$DEV_PROJECT_ID" >> $GITHUB_OUTPUT
          
          echo "üìã Configuration:"
          echo "  Version (from prod.tfvars): $VERSION"
          echo "  Prod Project: $PROJECT_ID"
          echo "  Dev Project: $DEV_PROJECT_ID"

      - uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.GCP_WIF_PROVIDER }}'
          service_account: ${{ steps.parse.outputs.service_account }}

      - uses: 'google-github-actions/setup-gcloud@v2'

      - name: Verify Artifacts Exist in Dev
        run: |
          VERSION="${{ steps.parse.outputs.version }}"
          DEV_PROJECT="${{ steps.parse.outputs.dev_project_id }}"
          
          echo "üîç Verifying artifacts exist in dev project: $DEV_PROJECT"
          echo "  Version: $VERSION"
          
          # Check container
          if ! gcloud artifacts docker images describe "us-central1-docker.pkg.dev/$DEV_PROJECT/repo/hubspoke-demo:$VERSION" --project=$DEV_PROJECT > /dev/null 2>&1; then
            echo "::error::Container image not found: us-central1-docker.pkg.dev/$DEV_PROJECT/repo/hubspoke-demo:$VERSION"
            exit 1
          fi
          echo "‚úÖ Container verified"
          
          # Check GCE image
          if ! gcloud storage ls "gs://hubspoke-demo-dev-nixos-images/nixos-image-$VERSION.tar.gz" > /dev/null 2>&1; then
            echo "::error::GCE image not found: gs://hubspoke-demo-dev-nixos-images/nixos-image-$VERSION.tar.gz"
            exit 1
          fi
          echo "‚úÖ GCE image verified"

  # Phase 2: Promote artifacts from dev to prod
  promote:
    needs: config
    uses: ./.github/workflows/promote-artifacts.yml
    with:
      version: ${{ needs.config.outputs.version }}
      source_project: ${{ needs.config.outputs.dev_project_id }}
      target_project: ${{ needs.config.outputs.project_id }}
    secrets:
      gcp_wif_provider: ${{ secrets.GCP_WIF_PROVIDER }}

  # Phase 3: Deploy infrastructure
  deploy:
    needs: [config, promote]
    # Only proceed if promotion succeeded (not if it was skipped)
    if: always() && needs.promote.result == 'success'
    environment: production  # Requires GitHub Environment protection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.GCP_WIF_PROVIDER }}'
          service_account: ${{ needs.config.outputs.service_account }}

      - uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.8.1'

      - uses: actions/cache@v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: tofu-plugins-${{ runner.os }}-${{ hashFiles('infra/.terraform.lock.hcl') }}

      - name: Configure Tofu Plugin Cache
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo "plugin_cache_dir = \"$HOME/.terraform.d/plugin-cache\"" > ~/.terraformrc

      - name: Tofu Init
        working-directory: ./infra
        run: tofu init -backend-config="bucket=${{ needs.config.outputs.state_bucket }}"

      - name: Tofu Plan
        working-directory: ./infra
        run: |
          echo "üìã Running tofu plan..."
          tofu plan \
            -var-file="prod.tfvars" \
            -no-color \
            -out=tfplan

      - name: Tofu Apply
        if: github.ref == 'refs/heads/main'
        working-directory: ./infra
        run: |
          echo "üöÄ Applying infrastructure changes..."
          tofu apply tfplan -no-color

      - name: Deployment Summary
        if: always()
        run: |
          if [ "${{ steps.apply.outcome }}" == "success" ]; then
            echo "‚úÖ Deployment completed successfully"
            echo "   Version: ${{ needs.config.outputs.version }}"
            echo "   Prod URL: https://$(gcloud run services describe hubspoke-demo --project=${{ needs.config.outputs.project_id }} --region=us-central1 --format='value(status.url)' | sed 's|https://||')"
          else
            echo "‚ùå Deployment failed - artifacts preserved in prod for retry"
            echo "   Version: ${{ needs.config.outputs.version }}"
          fi
