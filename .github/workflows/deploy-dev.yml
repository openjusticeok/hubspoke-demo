name: Deploy Dev

on:
  push:
    branches: [main]
    paths:
      - 'infra/**'
      - '.github/workflows/deploy-dev.yml'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse Environment Config
        id: config
        run: |
          # Extract state_bucket (Tofu backend)
          STATE_BUCKET=$(grep -E '^\s*state_bucket\s*=' infra/dev.tfvars | \
                        head -1 | \
                        sed -E 's/^\s*state_bucket\s*=\s*"([^"]+)".*/\1/')
          
          # Extract service_account
          SA=$(grep -E '^\s*service_account\s*=' infra/dev.tfvars | \
               head -1 | \
               sed -E 's/^\s*service_account\s*=\s*"([^"]+)".*/\1/')
          
          echo "State Bucket (Backend): $STATE_BUCKET"
          echo "Service Account: $SA"
          
          echo "state_bucket=$STATE_BUCKET" >> $GITHUB_OUTPUT
          echo "service_account=$SA" >> $GITHUB_OUTPUT

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: '${{ secrets.GCP_WIF_PROVIDER }}'
          service_account: ${{ steps.config.outputs.service_account }}

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.8.1'

      - name: Tofu Init
        working-directory: ./infra
        run: tofu init -backend-config="bucket=${{ steps.config.outputs.state_bucket }}"

      - name: Tofu Plan
        working-directory: ./infra
        run: tofu plan -var-file="dev.tfvars" -no-color

      - name: Tofu Apply
        if: github.ref == 'refs/heads/main'
        working-directory: ./infra
        run: tofu apply -var-file="dev.tfvars" -auto-approve -no-color
